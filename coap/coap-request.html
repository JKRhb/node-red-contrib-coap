<script type="text/javascript">
    RED.nodes.registerType("coap request", {
        category: "network",
        color: "#f4a261",
        defaults: {
            method: {
                value: "GET",
                validate: (v) => ["", "GET", "PUT", "POST", "DELETE", "FETCH", "PATCH", "iPATCH"].includes(v),
            },
            confirmable: { value: true, required: true },
            observe: { value: false, required: true },
            multicast: { value: false, required: true },
            multicastTimeout: { value: 20000, required: false },
            url: { value: "" },
            "content-format": { value: "text/plain" },
            name: { value: "" },
            paytoqs: {value: "ignore"},
        },
        inputs: 1,
        outputs: 1,
        icon: "white-globe.png",
        align: "left",
        label: function () {
            return this.name || this._("coapRequest.nodeLabel");
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            function updateMulticastOptions() {
                if ($("#node-input-multicast").is(":checked")) {
                    $("#node-input-multicast-row").show();
                } else {
                    $("#node-input-multicast-row").hide();
                }
            }
            if (this.multicast) {
                $("#node-input-multicast").prop("checked", true);
            } else {
                $("#node-input-multicast").prop("checked", false);
            }
            updateMulticastOptions();
            $("#node-input-multicast").on("click", function() {
                updateMulticastOptions();
            });
            $("#node-input-method").on("change", function() {
                if ($(this).val() === "GET") {
                    $(".node-input-paytoqs-row").show();
                } else {
                    $(".node-input-paytoqs-row").hide();
                }
            });
            if (this.paytoqs === true || this.paytoqs === "query") {
                $("#node-input-paytoqs").val("query");
            } else {
                $("#node-input-paytoqs").val("ignore");
            }
            $("#node-input-method").on("change", function() {
                if ($(this).val() === "GET") {
                    $(".form-row-coap-request-observe").show();
                } else {
                    $(".form-row-coap-request-observe").hide();
                }
            }).change();
        }
    });
</script>

<script type="text/html" data-template-name="coap request">

    <div class="form-row">
        <label for="node-input-url"> <i class="fa fa-globe"></i> <span data-i18n="coapRequest.inputURL.label"></span> </label>
        <input
            type="text"
            id="node-input-url"
            data-i18n="[placeholder]coapRequest.inputURL.placeholder"
        />
    </div>

    <div class="form-row">
        <label for="node-input-method">
            <i class="fa fa-tasks"></i> <span data-i18n="coapRequest.inputMethod.label"></span>
        </label>
        <select id="node-input-method">
            <option value="GET">GET</option>
            <option value="PUT">PUT</option>
            <option value="POST">POST</option>
            <option value="DELETE">DELETE</option>
            <option value="FETCH">FETCH</option>
            <option value="PATCH">PATCH</option>
            <option value="iPATCH">iPATCH</option>
            <option value="use" data-i18n="coapRequest.setby.label"></option>
        </select>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-confirmable" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-confirmable" style="width: auto" data-i18n="coapRequest.inputConfirmable.label"></label>
    </div>

    <div class="form-row node-input-paytoqs-row">
        <label for="node-input-paytoqs"><span data-i18n="coapRequest.paytoqs.label"></span></label>
        <select id="node-input-paytoqs" style="width: 70%;">
            <option value="ignore" data-i18n="coapRequest.paytoqs.ignore"></option>
            <option value="query" data-i18n="coapRequest.paytoqs.query"></option>
        </select>
    </div>

    <div class="form-row form-row-coap-request-observe hide">
        <input type="checkbox" id="node-input-observe" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-observe" style="width: auto" data-i18n="coapRequest.inputObserve.label"></label>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-multicast" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-multicast" style="width: auto" data-i18n="coapRequest.inputMulticast.label"></label>

        <div id="node-input-multicast-row" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-multicast-timeout">
                <i class="fa fa-clock-o"></i>
                <span data-i18n="coapRequest.inputMulticastTimeout.label"></span>
            </label>
            <input style="width: 270px" type="text" id="node-input-multicast-timeout" placeholder="20000" />
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-content-format"><i class="fa fa-arrow-left"></i> <span data-i18n="coapRequest.return.label"></span></label>
        <select type="text" id="node-input-content-format" style="width:70%;">
        <option value="text/plain" data-i18n="coapRequest.return.utf8"></option>
        <option value="raw-buffer" data-i18n="coapRequest.return.binary"></option>
        <option value="application/json" data-i18n="coapRequest.return.json"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="coapRequest.inputName.label"></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]coapRequest.inputName.placeholder" />
    </div>

    <div class="form-tips">
        <span data-i18n="[html]coapRequest.tip">
    </div>

</script>

